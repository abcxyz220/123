<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Admin – Thống kê</title>

  <!-- Bootstrap + Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">

  <link rel="stylesheet" href="../styles/base.css" />
  <style>
    main.container { max-width: var(--max); }
    .admin-head{ display:flex; align-items:center; justify-content:space-between; gap:12px; margin:10px 0 16px; }
    .admin-head h2{ margin:0; }
    .kpi-grid{ display:grid; grid-template-columns:repeat(3, minmax(180px,1fr)); gap:12px; }
    @media (max-width:900px){ .kpi-grid{ grid-template-columns:1fr; } }
    .kpi-card h3{ margin:0; }
    .tools{ display:flex; gap:8px; flex-wrap:wrap; align-items:end; }
    .tools .form-control{ max-width:200px; }
    .muted{ color:#6b7280; }
    .table thead th{ background:#f9fafb; }
    .warn{ color:#b45309; }
  </style>
</head>
<body>
  <!-- Header -->
  <div id="app-header"></div>

  <main class="container my-3">
    <div class="admin-head">
      <h2>Thống kê</h2>
      <a class="btn btn-outline-secondary" href="../index.html">
        <i class="bi bi-arrow-left"></i> Về trang bán hàng
      </a>
    </div>

    <!-- Bộ lọc -->
    <div class="card mb-3">
      <div class="card-body">
        <div class="tools">
          <div>
            <label class="form-label">Từ ngày</label>
            <input type="date" id="fromDate" class="form-control">
          </div>
          <div>
            <label class="form-label">Đến ngày</label>
            <input type="date" id="toDate" class="form-control">
          </div>
          <div class="d-flex gap-2">
            <button class="btn btn-outline-secondary" id="applyFilter"><i class="bi bi-funnel"></i> Lọc</button>
            <button class="btn btn-outline-secondary" id="clearFilter"><i class="bi bi-x-circle"></i> Bỏ lọc</button>
            <button class="btn btn-outline-primary" id="quick7"><i class="bi bi-calendar-week"></i> 7 ngày</button>
            <button class="btn btn-outline-primary" id="quick30"><i class="bi bi-calendar3"></i> 30 ngày</button>
          </div>
        </div>
      </div>
    </div>

    <!-- KPI -->
    <div class="kpi-grid mb-3">
      <div class="card kpi-card"><div class="card-body"><div class="muted">Sản phẩm được đặt</div><h3 id="kpiOrdered">0</h3></div></div>
      <div class="card kpi-card"><div class="card-body"><div class="muted">Doanh thu</div><h3 id="kpiRevenue">0</h3></div></div>
      <div class="card kpi-card"><div class="card-body"><div class="muted">Hàng tồn (biến thể)</div><h3 id="kpiInventory">0</h3></div></div>
    </div>

    <!-- Chart + bảng -->
    <div class="row g-3">
      <div class="col-12 col-lg-7">
        <div class="card h-100">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-center mb-2">
              <h5 class="m-0">Doanh thu theo ngày</h5>
              <small class="muted" id="rangeLabel">—</small>
            </div>
            <canvas id="revChart" height="120"></canvas>
          </div>
        </div>
      </div>
      <div class="col-12 col-lg-5">
        <div class="card h-100">
          <div class="card-body">
            <h5 class="mb-2">Top sản phẩm</h5>
            <div class="table-responsive">
              <table class="table mb-0 align-middle">
                <thead><tr><th>Sản phẩm</th><th class="text-end">Doanh thu</th><th class="text-end">SL</th></tr></thead>
                <tbody id="topProductsBody"><tr><td colspan="3" class="text-center text-muted">Đang tính…</td></tr></tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Tồn kho thấp -->
    <div class="card mt-3">
      <div class="card-body">
        <h5 class="mb-2">Tồn kho thấp (biến thể)</h5>
        <div class="table-responsive">
          <table class="table mb-0 align-middle">
            <thead><tr><th>Sản phẩm</th><th>Biến thể</th><th class="text-end">Tồn</th></tr></thead>
            <tbody id="lowStockBody"><tr><td colspan="3" class="text-center text-muted">Đang tính…</td></tr></tbody>
          </table>
        </div>
        <div class="mt-2"><small class="muted">Ngưỡng cảnh báo mặc định: &le; 3.</small></div>
      </div>
    </div>
  </main>

  <!-- Footer (tùy chọn) -->
  <div id="app-footer"></div>

  <!-- Libs -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>

  <!-- Core JS (THỨ TỰ BẮT BUỘC) -->
  <script src="../js/utils.js"></script>
  <script src="../js/cart.js"></script>

  <!-- API config + modules -->
  <script src="../js/api/_config.js"></script>
  <script src="../js/api/categories.js"></script>
  <script src="../js/api/products.js"></script>
  <script src="../js/api/users.js"></script>
  <script src="../js/api/orders.js"></script>

  <!-- Auth + Header/Footer -->
  <script src="../js/auth.js"></script>
  <script>window.PARTIAL_BASE='..';</script>
  <script src="../js/layout.js"></script>

  <!-- Page logic -->
  <script>
    (() => {
      const $ = (id) => document.getElementById(id);
      const dom = {
        kpiOrdered: $('kpiOrdered'), kpiRevenue: $('kpiRevenue'), kpiInventory: $('kpiInventory'),
        rangeLabel: $('rangeLabel'), topProductsBody: $('topProductsBody'), lowStockBody: $('lowStockBody'),
        fromDate: $('fromDate'), toDate: $('toDate'), applyFilter: $('applyFilter'), clearFilter: $('clearFilter'),
        quick7: $('quick7'), quick30: $('quick30'), revChart: $('revChart')
      };
      let chart;

      const formatMoney = (n)=>{ try{return formatVND(Number(n||0));}catch{return Number(n||0).toLocaleString('vi-VN')+' ₫';} };
      const esc = (s='')=>String(s).replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
      const dayStart = (d)=>{const x=new Date(d);x.setHours(0,0,0,0);return x;};
      const dayEnd = (d)=>{const x=new Date(d);x.setHours(23,59,59,999);return x;};
      const fmtDate = (d)=> new Date(d).toLocaleDateString('vi-VN');
      const defaultRange = (days=7)=>({from:dayStart(new Date(Date.now()-(days-1)*86400000)), to:dayEnd(new Date())});
      const inRange=(dt,from,to)=>{const t=new Date(dt).getTime();return(!from||t>=from.getTime())&&(!to||t<=to.getTime());};

      function groupByDate(items, from, to){
        const map=new Map();
        if(from&&to){
          for(let d=new Date(from); d<=to; d=new Date(d.getTime()+86400000)){
            const k=d.toISOString().slice(0,10); map.set(k,{qty:0,revenue:0});
          }
        }
        for(const it of items){
          const k=new Date(it._order_created||it.created_date||Date.now()).toISOString().slice(0,10);
          if(from&&to){ const dd=new Date(k); if(dd<dayStart(from)||dd>dayEnd(to)) continue; }
          const rec=map.get(k)||{qty:0,revenue:0};
          rec.qty += Number(it.quantity||0);
          rec.revenue += Number(it.quantity||0)*Number(it.unit_price||0);
          map.set(k,rec);
        }
        const labels=[...map.keys()].sort();
        return {labels, qty:labels.map(k=>map.get(k).qty), rev:labels.map(k=>map.get(k).revenue)};
      }

      function topProducts(items, limit=8){
        const m=new Map();
        for(const it of items){
          const name=it.product_name||'—';
          const rec=m.get(name)||{qty:0,revenue:0};
          rec.qty+=Number(it.quantity||0);
          rec.revenue+=Number(it.quantity||0)*Number(it.unit_price||0);
          m.set(name,rec);
        }
        return [...m.entries()].sort((a,b)=>b[1].revenue-a[1].revenue).slice(0,limit);
      }

      function lowStock(variants, threshold=3){
        return (variants||[]).filter(v=>Number(v.quantity||0)<=threshold).sort((a,b)=>(a.quantity||0)-(b.quantity||0));
      }

      function renderTopProducts(rows){
        dom.topProductsBody.innerHTML = rows.length
          ? rows.map(([name,rec])=>`<tr><td>${esc(name)}</td><td class="text-end">${formatMoney(rec.revenue)}</td><td class="text-end">${rec.qty}</td></tr>`).join('')
          : `<tr><td colspan="3" class="text-center text-muted">Không có dữ liệu.</td></tr>`;
      }
      function renderLowStock(rows){
        dom.lowStockBody.innerHTML = rows.length
          ? rows.map(v=>`<tr><td>${esc(v.product_name||'—')}</td><td>${esc(v.variant_name||'—')}</td><td class="text-end ${Number(v.quantity||0)<=1?'warn':''}">${Number(v.quantity||0)}</td></tr>`).join('')
          : `<tr><td colspan="3" class="text-center text-muted">Tồn kho đang ổn.</td></tr>`;
      }
      function renderChart(labels, revenues){
        if(chart) chart.destroy();
        chart = new Chart(dom.revChart.getContext('2d'), {
          type:'line',
          data:{ labels, datasets:[{ label:'Doanh thu (₫)', data:revenues, tension:.3 }]},
          options:{ responsive:true, plugins:{ legend:{display:false}, tooltip:{callbacks:{label:c=>formatMoney(c.parsed.y)}} },
                    scales:{ y:{ ticks:{ callback:v=>formatMoney(v) }}} }
        });
      }

      // Fallback: nếu Products.allVariants không có thì lấy từ dbGet()
      async function safeAllVariants(){
        try{
          if (window.Products?.allVariants) {
            const v = await Products.allVariants();
            if (Array.isArray(v)) return v;
          }
        }catch{}
        try{
          if (typeof dbGet === 'function'){
            const db = dbGet()||{};
            return Array.isArray(db.product_variants) ? db.product_variants : [];
          }
        }catch{}
        return [];
      }

      async function purgeOrphanOrderItems(){
        if(typeof dbGet!=='function'||typeof dbSet!=='function') return;
        const db=dbGet()||{};
        const orders=Array.isArray(db.orders)?db.orders:[];
        const items=Array.isArray(db.order_items)?db.order_items:(Array.isArray(db.orderDetails)?db.orderDetails:[]);
        if(!items.length) return;
        const liveIds=new Set(orders.map(o=>String(o.id)));
        const filtered=items.filter(it=>liveIds.has(String(it.order_id)));
        if(filtered.length!==items.length){ db.order_items=filtered; db.orderDetails=filtered; dbSet(db); }
      }

      async function getLiveOrderItems(){
        const orders = await (Orders.all ? Orders.all() : []);
        const liveOrders = orders.filter(o => (o.status||'') !== 'cancelled');
        const byId = new Map(liveOrders.map(o => [String(o.id), o]));
        if(Orders.allItems){
          const items = await Orders.allItems();
          return (items||[]).filter(it=>byId.has(String(it.order_id)))
            .map(it=>({ ...it, _order_created: byId.get(String(it.order_id))?.created_date || it.created_date }));
        }
        const chunks = await Promise.all(liveOrders.map(async o=>{
          const its = await Orders.items(o.id) || [];
          return its.map(x => ({ ...x, _order_created:o.created_date }));
        }));
        return chunks.flat();
      }

      async function computeAndRender(){
        await purgeOrphanOrderItems();
        const from = dom.fromDate.value ? dayStart(new Date(dom.fromDate.value)) : null;
        const to   = dom.toDate.value ? dayEnd(new Date(dom.toDate.value)) : null;
        dom.rangeLabel.textContent = (from||to) ? `${from?fmtDate(from):'…'} → ${to?fmtDate(to):'…'}` : 'Tất cả thời gian';

        const [itemsRaw, variants] = await Promise.all([getLiveOrderItems(), safeAllVariants()]);
        const ordered = itemsRaw.reduce((s,it)=>s+Number(it.quantity||0),0);
        const revenue = itemsRaw.reduce((s,it)=>s+Number(it.quantity||0)*Number(it.unit_price||0),0);
        const inventory = (variants||[]).reduce((s,v)=>s+Number(v.quantity||0),0);
        dom.kpiOrdered.textContent = ordered;
        dom.kpiRevenue.textContent = formatMoney(revenue);
        dom.kpiInventory.textContent = inventory;

        const ranged = (from||to) ? itemsRaw.filter(it=>inRange(it._order_created||it.created_date||Date.now(), from, to)) : itemsRaw;
        const {labels, rev} = groupByDate(ranged, from, to);
        renderChart(labels.map(s=>s.slice(8,10)+'/'+s.slice(5,7)), rev);
        renderTopProducts(topProducts(ranged, 8));
        renderLowStock(lowStock(variants, 3));
      }

      dom.quick7.addEventListener('click', ()=>{ const {from,to}=defaultRange(7); dom.fromDate.value=from.toISOString().slice(0,10); dom.toDate.value=to.toISOString().slice(0,10); computeAndRender(); });
      dom.quick30.addEventListener('click', ()=>{ const {from,to}=defaultRange(30); dom.fromDate.value=from.toISOString().slice(0,10); dom.toDate.value=to.toISOString().slice(0,10); computeAndRender(); });
      dom.applyFilter.addEventListener('click', computeAndRender);
      dom.clearFilter.addEventListener('click', ()=>{ dom.fromDate.value=''; dom.toDate.value=''; computeAndRender(); });

      (()=>{
        const {from,to}=defaultRange(7);
        dom.fromDate.value=from.toISOString().slice(0,10);
        dom.toDate.value=to.toISOString().slice(0,10);
        computeAndRender();
      })();
    })();
  </script>
</body>
</html>
