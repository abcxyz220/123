<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Admin – Quản lý đơn hàng</title>

  <!-- Bootstrap + Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">

  <!-- CSS -->
  <link rel="stylesheet" href="../styles/base.css"/>
  <style>
    main.container { max-width: var(--max); }
    .admin-head { display:flex; align-items:center; justify-content:space-between; gap:12px; margin:10px 0 16px; }
    .admin-head h2 { margin:0; }
    .tools { display:flex; gap:8px; flex-wrap:wrap; align-items:end; margin: 0 0 12px 0; }
    .tools .form-control, .tools .form-select { max-width: 220px; }
    .cell-actions { white-space: nowrap; width: 260px; }
    .status-select { min-width: 160px; }
    .muted { color:#6b7280; }
  </style>
</head>
<body>

  <div id="app-header"></div>

  <main class="container my-3">
    <div class="admin-head">
      <h2>Quản lý đơn hàng</h2>
      <a class="btn btn-outline-secondary" href="../index.html">
        <i class="bi bi-arrow-left"></i> Về trang bán hàng
      </a>
    </div>

    <div class="card mb-3">
      <div class="card-body">
        <div class="tools">
          <div>
            <label class="form-label">Trạng thái</label>
            <select id="statusFilter" class="form-select">
              <option value="">Tất cả</option>
              <option value="pending">Chờ xử lý</option>
              <option value="processing">Đang xử lý</option>
              <option value="shipped">Đã giao cho đơn vị VC</option>
              <option value="completed">Hoàn tất</option>
              <option value="cancelled">Hủy</option>
            </select>
          </div>
          <div>
            <label class="form-label">Khách hàng</label>
            <input id="kw" class="form-control" placeholder="Tên hoặc email KH…">
          </div>
          <div>
            <label class="form-label">Từ ngày</label>
            <input id="fromDate" type="date" class="form-control">
          </div>
          <div>
            <label class="form-label">Đến ngày</label>
            <input id="toDate" type="date" class="form-control">
          </div>
          <div class="d-flex gap-2">
            <button class="btn btn-outline-secondary" id="applyFilter"><i class="bi bi-funnel"></i> Lọc</button>
            <button class="btn btn-outline-secondary" id="clearFilter"><i class="bi bi-x-circle"></i> Bỏ lọc</button>
          </div>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="card-body p-0">
        <div id="tableWrap"></div>
      </div>
    </div>
  </main>

  <!-- Modal chi tiết -->
  <div class="modal fade" id="orderModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Chi tiết đơn hàng</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Đóng"></button>
        </div>
        <div class="modal-body" id="orderDetailBody"></div>
        <div class="modal-footer">
          <button class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Libs -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <!-- Scripts (đúng đường dẫn + thứ tự) -->
  <script src="../js/utils.js"></script>
  <script src="../js/cart.js"></script>

  <script src="../js/api/_config.js"></script>
  <script src="../js/api/categories.js"></script>
  <script src="../js/api/products.js"></script>
  <script src="../js/api/users.js"></script>
  <script src="../js/api/orders.js"></script>

  <script src="../js/auth.js"></script>
  <script>window.PARTIAL_BASE='..';</script>
  <script src="../js/layout.js"></script>

  <script>
    const $ = (id) => document.getElementById(id);
    const dom = {
      tableWrap: $('tableWrap'),
      statusFilter: $('statusFilter'),
      kw: $('kw'),
      fromDate: $('fromDate'),
      toDate: $('toDate'),
      applyFilter: $('applyFilter'),
      clearFilter: $('clearFilter'),
      orderDetailBody: $('orderDetailBody'),
    };

    let cache = [];

    function formatMoney(n){ try { return formatVND(Number(n||0)); } catch { return Number(n||0).toLocaleString('vi-VN') + ' ₫'; } }
    function esc(s=''){ return String(s).replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m])); }

    // Fallback local: update status / remove
    async function updateStatusLocal(orderId, newStatus){
      const db = dbGet();
      const it = (db.orders||[]).find(o => String(o.id) === String(orderId));
      if (it){ it.status = newStatus; dbSet(db); }
    }
    async function safeOrdersRemove(orderId){
      if (window.Orders?.remove) return Orders.remove(orderId);
      const db = dbGet();
      db.orders = (db.orders||[]).filter(o => String(o.id) !== String(orderId));
      // cả hai cách đặt tên chi tiết
      db.order_details = (db.order_details||[]).filter(d => String(d.order_id) !== String(orderId));
      db.order_items   = (db.order_items||[]).filter(d => String(d.order_id) !== String(orderId));
      dbSet(db);
    }

    // Enrich đơn
    async function enrichOrders(raw){
      const out = [];
      for (const o of (raw||[])){
        const u = await Users.get(o.user_id);
        let items = await Orders.items(o.id) || [];
        // Bổ sung tên nếu thiếu
        for (const it of items){
          if (!it.product_name || !it.variant_name){
            try{
              const p = await Products.get(it.product_id);
              if (p && !it.product_name) it.product_name = p.name || ('#'+it.product_id);
              const vs = await Products.variants ? await Products.variants(it.product_id) : (dbGet().product_variants||[]);
              const v = (vs||[]).find(x => Number(x.id) === Number(it.variant_id));
              if (v && !it.variant_name) it.variant_name = v.variant_name || 'Mặc định';
            }catch{}
          }
        }
        const total = (items||[]).reduce((s,it)=> s + Number(it.unit_price||0)*Number(it.quantity||0), 0);
        out.push({ ...o,
          _userName: u ? (u.name || u.email || ('#'+u.id)) : '—',
          _userEmail: u ? (u.email || '') : '',
          _items: items, _total: total
        });
      }
      return out;
    }

    // Lọc local
    function applyLocalFilter(){
      const st = dom.statusFilter.value;
      const kw = (dom.kw.value||'').trim().toLowerCase();
      const from = dom.fromDate.value ? new Date(dom.fromDate.value) : null;
      const to   = dom.toDate.value   ? new Date(dom.toDate.value)   : null;
      let list = [...cache];

      if (st) list = list.filter(o => (o.status||'') === st);
      if (kw) list = list.filter(o => (o._userName||'').toLowerCase().includes(kw) || (o._userEmail||'').toLowerCase().includes(kw));
      if (from) list = list.filter(o => new Date(o.created_date) >= from);
      if (to)   list = list.filter(o => new Date(o.created_date) <= new Date(to.getTime()+86400000-1));
      renderTable(list);
    }

    function statusOptions(cur){
      const opts = [
        {v:'pending', t:'Chờ xử lý'},
        {v:'processing', t:'Đang xử lý'},
        {v:'shipped', t:'Đã giao cho đơn vị VC'},
        {v:'completed', t:'Hoàn tất'},
        {v:'cancelled', t:'Hủy'},
      ];
      return opts.map(o => `<option value="${o.v}" ${o.v===cur?'selected':''}>${o.t}</option>`).join('');
    }

    function renderTable(list){
      const rows = (list||[]).map(o => `
        <tr data-id="${o.id}">
          <td style="width:120px" class="text-secondary">${o.id}</td>
          <td>
            <div><strong>${esc(o._userName)}</strong></div>
            <div class="muted">${esc(o._userEmail||'')}</div>
          </td>
          <td>${new Date(o.created_date).toLocaleString()}</td>
          <td style="width:200px">
            <select class="form-select form-select-sm status-select act-status">
              ${statusOptions(o.status)}
            </select>
          </td>
          <td>${formatMoney(o._total)}</td>
          <td class="cell-actions text-end">
            <button class="btn btn-sm btn-outline-primary me-1 act-view"><i class="bi bi-eye"></i> Xem</button>
            <button class="btn btn-sm btn-outline-danger act-del"><i class="bi bi-trash3"></i> Xóa</button>
          </td>
        </tr>`).join('');
      dom.tableWrap.innerHTML = `
        <table class="table mb-0 align-middle">
          <thead>
            <tr>
              <th style="width:120px">ID</th>
              <th>Khách</th>
              <th>Ngày tạo</th>
              <th style="width:200px">Trạng thái</th>
              <th>Tổng</th>
              <th class="text-end" style="width:260px">Thao tác</th>
            </tr>
          </thead>
          <tbody>
            ${rows || `<tr><td colspan="6" class="py-4 text-center text-muted">Chưa có đơn hàng.</td></tr>`}
          </tbody>
        </table>`;
    }

    function renderOrderDetail(o){
      const rows = (o._items||[]).map(it => `
        <tr>
          <td>${esc(it.product_name||('SP #'+it.product_id))}</td>
          <td>${esc(it.variant_name||('Biến thể #'+it.variant_id))}</td>
          <td>${Number(it.quantity||0)}</td>
          <td>${formatMoney(it.unit_price||0)}</td>
          <td>${formatMoney(Number(it.unit_price||0)*Number(it.quantity||0))}</td>
        </tr>`).join('');
      dom.orderDetailBody.innerHTML = `
        <div class="mb-2">
          <div><strong>Đơn hàng #${o.id}</strong></div>
          <div class="muted">Khách hàng: <strong>${esc(o._userName)}</strong> ${o._userEmail ? '('+esc(o._userEmail)+')' : ''}</div>
          <div class="muted">Ngày tạo: ${new Date(o.created_date).toLocaleString()}</div>
          <div class="muted">Trạng thái: ${esc(o.status||'')}</div>
        </div>
        <div class="table-responsive">
          <table class="table align-middle">
            <thead><tr><th>Sản phẩm</th><th>Biến thể</th><th>SL</th><th>Đơn giá</th><th>Thành tiền</th></tr></thead>
            <tbody>${rows || `<tr><td colspan="5" class="text-center text-muted">Không có dòng hàng.</td></tr>`}</tbody>
            <tfoot><tr><th colspan="4" class="text-end">Tổng</th><th>${formatMoney(o._total||0)}</th></tr></tfoot>
          </table>
        </div>`;
      const modal = new bootstrap.Modal(document.getElementById('orderModal'));
      modal.show();
    }

    // Events
    document.addEventListener('change', async (e) => {
      if (!e.target.closest('.act-status')) return;
      const tr = e.target.closest('tr[data-id]'); if (!tr) return;
      const id = tr.getAttribute('data-id');
      const val = e.target.value;
      try{
        if (Orders.update) await Orders.update(id, { status: val });
        else await updateStatusLocal(id, val);
      }catch(err){ console.error(err); alert('Không thể cập nhật trạng thái'); }
    });

    document.addEventListener('click', async (e) => {
      const tr = e.target.closest('tr[data-id]'); if (!tr) return;
      const id = tr.getAttribute('data-id');

      if (e.target.closest('.act-view')) {
        const obj = cache.find(x => String(x.id) === String(id));
        if (obj) renderOrderDetail(obj);
        return;
      }

      if (e.target.closest('.act-del')) {
        const obj = cache.find(x => String(x.id) === String(id));
        const name = obj ? (obj._userName || ('#'+obj.user_id)) : '';
        if (!confirm(`Xóa đơn #${id} của khách "${name}"?`)) return;
        try{
          await safeOrdersRemove(id);
          const raw = await Orders.all();
          cache = await enrichOrders(raw||[]);
          renderTable(cache);
        }catch(err){ console.error(err); alert('Không thể xóa đơn hàng.'); }
      }
    });

    dom.applyFilter.addEventListener('click', applyLocalFilter);
    dom.clearFilter.addEventListener('click', () => {
      dom.statusFilter.value = ''; dom.kw.value = ''; dom.fromDate.value = ''; dom.toDate.value = ''; renderTable(cache);
    });

    (async () => {
      const raw = await Orders.all();
      cache = await enrichOrders(raw||[]);
      renderTable(cache);
    })();
  </script>
</body>
</html>
